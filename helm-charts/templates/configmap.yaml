apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "gateway.fullname" . }}-config
  labels:
    {{- include "gateway.labels" . | nindent 4 }}
data:
  appsettings.json: |
    {
      "Logging": {
        "LogLevel": {
          "Default": "Information",
          "Microsoft.AspNetCore": "Warning"
        }
      },
      "AllowedHosts": "*",
      "Jwt": {
        "Issuer": "{{ .Values.config.jwt.issuer }}",
        "Audience": "{{ .Values.config.jwt.audience }}",
        "Key": "{{ .Values.config.jwt.key }}"
      },
      "Serilog": {
        "Using": ["Serilog.Sinks.Console"],
        "MinimumLevel": "Information",
        "WriteTo": [
          { "Name": "Console" }
        ]
      },
      "ReverseProxy": {
        "Routes": {
          "notification-route": {
            "ClusterId": "notification-cluster",
            "Match": {
              "Path": "/api/{**catch-all}"
            },
            "Transforms": [
              { "PathPattern": "/api/{**catch-all}" }
            ]
          },
          "notification-route-hub": {
            "ClusterId": "notification-cluster",
            "Match": {
              "Path": "/hub/notifyHub/{**catch-all}"
            },
            "Transforms": [
              { "PathPattern": "/hub/notifyHub/{**catch-all}" }
            ]
          },
          "post-route": {
            "ClusterId": "post-cluster",
            "Match": {
              "Path": "/api/{**catch-all}"
            },
            "Transforms": [
              { "PathPattern": "/api/{**catch-all}" }
            ]
          },
          "identity-route": {
            "ClusterId": "identity-cluster",
            "Match": {
              "Path": "/api/{**catch-all}"
            },
            "Transforms": [
              { "PathPattern": "/api/{**catch-all}" }
            ]
          }
        },
        "Clusters": {
          "notification-cluster": {
            "Destinations": {
              "destination1": {
                "Address": "http://notification-service:80/"
              }
            }
          },
          "post-cluster": {
            "Destinations": {
              "destination1": {
                "Address": "http://post-service:80/"
              }
            }
          },
          "identity-cluster": {
            "Destinations": {
              "destination1": {
                "Address": "http://identity-service:80/"
              }
            }
          }
        }
      }
    }